<!DOCTYPE html>
<html lang="zh-TW">
<head>
        
        <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-K2VQTGFM');</script>
        

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>貓咪談心室</title>
    
    <script src="{{ url_for('static', filename='tailwind-3.4.17.js') }}"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
            @import url(https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;500;700&display=swap);
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #FDFCFB;
            background-image: linear-gradient(160deg, #FDFCFB 0%, #E2D1C3 100%);
        }

        body.deep-chat-theme {
            background-color: #f6f2ff;
            background-image: linear-gradient(160deg, #fbf9ff 0%, #ece4ff 100%);
        }

        :root {
            --bg-main: #F8F7FC; 
            --bg-secondary: #FFFFFF;
            --text-primary: #4A4A68; 
            --text-secondary: #8A8A9E;
            --accent-primary: #A491D3;
            --accent-primary-hover: #9279C5;
            --user-bubble: #F1EDF9;
            --gemini-bubble: #FBFBFB; 
            --shadow-color: rgba(146, 121, 197, 0.1);
            --box-color: #d7b494;
            --box-dark: #b69375;
            --table-color: #8d6e63;
            --cat-color: #8e8e8e;
            --cat-light: #d0d0d0;
            --paw-pink: #f8bbd0;
        }
        .transition-all { transition: all 0.3s ease-in-out; }
        .view-transition {
            transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
        }
        .chat-bubble {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeIn 0.5s forwards;
        }
        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .dot-flashing {
            position: relative;
            width: 8px;
            height: 8px;
            border-radius: 5px;
            background-color: var(--accent-primary);
            color: var(--accent-primary);
            animation: dotFlashing 1s infinite linear alternate;
            animation-delay: .5s;
        }
        .dot-flashing::before, .dot-flashing::after {
            content: '';
            display: inline-block;
            position: absolute;
            top: 0;
        }
        .dot-flashing::before {
            left: -12px;
            width: 8px;
            height: 8px;
            border-radius: 5px;
            background-color: var(--accent-primary);
            color: var(--accent-primary);
            animation: dotFlashing 1s infinite alternate;
            animation-delay: 0s;
        }
        .dot-flashing::after {
            left: 12px;
            width: 8px;
            height: 8px;
            border-radius: 5px;
            background-color: var(--accent-primary);
            color: var(--accent-primary);
            animation: dotFlashing 1s infinite alternate;
            animation-delay: 1s;
        }
        @keyframes dotFlashing {
            0% { background-color: var(--accent-primary); }
            50%, 100% { background-color: rgba(164, 145, 211, 0.2); }
        }
        .custom-shadow {
             box-shadow: 0 4px 10px -1px var(--shadow-color), 0 2px 8px -2px var(--shadow-color);
        }
        .custom-shadow-lg {
            box-shadow: 0 10px 20px -3px var(--shadow-color), 0 4px 8px -4px var(--shadow-color);
        }

        .summary-card {
            max-width: clamp(520px, 70vw, 760px);
            margin: 0 auto;
            padding: clamp(24px, 4vw, 48px);
        }
        .summary-card h3 {
            font-size: 1.5rem;
            letter-spacing: 0.04em;
        }
        .summary-card #report-summary {
            font-size: 1.06rem;
            line-height: 1.8;
        }

        .magic-overlay {
            position: fixed;
            inset: 0;
            background: rgba(44, 27, 67, 0.78);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 18px;
            z-index: 1200;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .magic-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        .magic-overlay.orange-mode {
            --cat-color: #d8905b;
            --cat-light: #f1c9a4;
            --paw-pink: #f5b3c5;
        }
        .magic-overlay-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.94), rgba(239,235,255,0.96));
            border-radius: 24px;
            padding: clamp(32px, 5vw, 64px);
            box-shadow: 0 24px 48px rgba(57, 37, 99, 0.25);
            text-align: center;
            max-width: 560px;
            width: min(92%, 560px);
            border: 1px solid rgba(164, 145, 211, 0.35);
        }
        .magic-animation-frame {
            width: min(480px, 92vw);
            margin: 0 auto 10px;
        }
        .magic-animation-svg {
            width: 100%;
            height: auto;
            display: block;
            transform-origin: center;
        }
        .magic-animation-svg .cat-arm-active,
        .magic-animation-svg .cat-tail,
        .magic-animation-svg .target-box {
            animation: none;
        }
        .magic-animation-svg.magic-animate .cat-arm-active {
            animation: arm-swat 2.5s infinite cubic-bezier(0.6, -0.28, 0.735, 0.045);
            transform-origin: 220px 260px;
        }
        .magic-animation-svg.magic-animate .cat-tail {
            animation: tail-wag 1.5s ease-in-out infinite;
            transform-origin: 165px 280px;
        }
        .magic-animation-svg.magic-animate .target-box {
            animation: box-fall 2.5s infinite ease-out;
            transform-origin: bottom center;
        }
        @keyframes box-fall {
            0%, 40.5% { transform: translate(0, 0) rotate(0deg); opacity: 1; }
            41% { transform: translate(5px, -2px) rotate(2deg); }
            42% { transform: translate(150px, -80px) rotate(60deg); opacity: 1; }
            50% { transform: translate(600px, 150px) rotate(240deg); opacity: 0; }
            100% { transform: translate(0, 0) rotate(0deg); opacity: 0; }
        }
        @keyframes arm-swat {
            0%, 30% { transform: rotate(0deg); }
            35% { transform: rotate(-25deg); }
            41% { transform: rotate(75deg); }
            55% { transform: rotate(0deg); }
            100% { transform: rotate(0deg); }
        }
        @keyframes tail-wag {
            0%, 100% { transform: rotate(0deg); }
            20% { transform: rotate(-15deg); }
            40% { transform: rotate(10deg); }
            60% { transform: rotate(-10deg); }
            80% { transform: rotate(5deg); }
        }
        .magic-animation-svg #targetText {
            font-size: clamp(10px, 1vw, 12px);
        }
        .magic-message {
            font-size: 1.05rem;
            color: #5d4a83;
            line-height: 1.7;
            margin-top: 8px;
        }
        .petting-overlay {
            display: none;
            text-align: center;
        }
        .petting-overlay.active {
            display: block;
        }
        .petting-container {
            position: relative;
            width: 100%;
            height: 0;
            padding-bottom: 95%;
        }
        .petting-container canvas {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
        }
        .heart,
        .feedback-emoji {
            position: absolute;
            pointer-events: none;
            font-size: clamp(1.25rem, 2vw, 2rem);
            animation: floatUp 1.2s ease-out forwards;
            z-index: 5;
        }
        .heart {
            color: #ff6b6b;
        }
        .feedback-emoji {
            color: #f9a8d4;
        }
        @keyframes floatUp {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateY(-80px) scale(1.5);
                opacity: 0;
            }
        }
        .card-paw-decoration {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100' fill='%23F1EDF9'%3E%3Cpath d='M65.2 55.8c-1.8-1.8-4.2-2.8-6.7-2.8s-4.9 1-6.7 2.8c-3.7 3.7-3.7 9.7 0 13.4 1.8 1.8 4.2 2.8 6.7 2.8s4.9-1 6.7-2.8c3.7-3.7 3.7-9.7 0-13.4zm19.5-19.5c-1.8-1.8-4.2-2.8-6.7-2.8s-4.9 1-6.7 2.8c-3.7 3.7-3.7 9.7 0 13.4 1.8 1.8 4.2 2.8 6.7 2.8s4.9-1 6.7-2.8c3.7-3.7 3.7-9.7 0-13.4zm-39 0c-1.8-1.8-4.2-2.8-6.7-2.8s-4.9 1-6.7 2.8c-3.7 3.7-3.7 9.7 0 13.4 1.8 1.8 4.2 2.8 6.7 2.8s4.9-1 6.7-2.8c3.7-3.7 3.7-9.7 0-13.4zm-19.5 19.5c-1.8-1.8-4.2-2.8-6.7-2.8s-4.9 1-6.7 2.8c-3.7 3.7-3.7 9.7 0 13.4 1.8 1.8 4.2 2.8 6.7 2.8s4.9-1 6.7-2.8c3.7-3.7 3.7-9.7 0-13.4zM50 0C22.4 0 0 22.4 0 50s22.4 50 50 50 50-22.4 50-50S77.6 0 50 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: top 0.5rem right 0.5rem;
            background-size: 4rem;
            position: relative;
        }
        textarea {
            resize: none;
            overflow-y: hidden;
        }

        .selection-mode-card {
            position: relative;
            overflow: hidden;
        }
        .selection-mode-card > *:not(.selection-bubble-container) {
            position: relative;
            z-index: 1;
        }
        .selection-bubble-container {
            position: absolute;
            inset: 0;
            pointer-events: none;
            overflow: hidden;
            z-index: 0;
        }
        .selection-bubble {
            position: absolute;
            bottom: -80px;
            border-radius: 9999px;
            background: rgba(209, 196, 233, 0.45);
            box-shadow: 0 0 18px rgba(255, 255, 255, 0.35);
            transform: translateY(0) scale(0.7);
            opacity: 0;
            animation: selectionBubbleFloat linear forwards;
        }
        @keyframes selectionBubbleFloat {
            0% {
                transform: translateY(0) scale(0.6);
                opacity: 0;
            }
            20% {
                opacity: var(--bubble-opacity, 0.6);
            }
            100% {
                transform: translateY(-120%) scale(1.4);
                opacity: 0;
            }
        }


        .brand-intro-modal {
            background: rgba(32, 24, 50, 0.72);
        }

        .brand-intro-card {
            max-width: 480px;
            width: min(92%, 480px);
            background: #fff8f3;
        }

        .brand-intro-card img {
            width: 100%;
            height: auto;
            display: block;
        }

        .grandma-avatar, .reporter-avatar, .user-avatar {
            width: 52px;
            height: 52px;
            border-radius: 9999px;
            object-fit: cover;
            flex-shrink: 0;
        }
        @media (max-width: 640px) {
            .grandma-avatar, .reporter-avatar, .user-avatar {
                width: 48px;
                height: 48px;
            }
        }

        .paw-button {
            background: none;
            border: none;
            padding: 4px;
            line-height: 0;
            cursor: pointer;
            transition: transform 0.12s ease-in-out;
            flex-shrink: 0;
        }
        .paw-button:focus-visible {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }
        .paw-button[disabled] {
            cursor: not-allowed;
            opacity: 0.5;
        }
        .send-icon {
            display: block;
            width: 40px;
            height: 40px;
            font-size: 32px;
            line-height: 40px;
            text-align: center;
        }
        .send-icon.paw {
            color: #A491D3;
        }
        .send-icon.mic {
            color: #FF9AA2;
        }
        .paw-button[disabled] .send-icon {
            color: #d5c8f0;
        }
        @keyframes bounce-stamp {
            0% { transform: translateY(0) scale(1); }
            30% { transform: translateY(6px) scale(0.9); }
            60% { transform: translateY(-3px) scale(1.06); }
            100% { transform: translateY(0) scale(1); }
        }
        .paw-button.is-sending .send-icon.paw {
            animation: bounce-stamp 0.6s ease-out 1;
        }
        .paw-button.is-sending .send-icon.mic {
            animation: spin 0.6s ease-out 1;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes grandma-avatar-pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 215, 99, 0.9); }
            70% { transform: scale(1.08); box-shadow: 0 0 0 14px rgba(255, 215, 99, 0); }
            100% { transform: scale(1); box-shadow: none; }
        }

        .grandma-avatar.is-speaking, .reporter-avatar.is-speaking {
            animation: grandma-avatar-pulse 0.8s ease-out 1;
        }

        .chat-message {
            font-size: 16px;
            line-height: 1.6;
        }
        @media (min-width: 768px) {
            .chat-message {
                font-size: 17px;
            }
        }

        .chat-input-wrapper {
            width: min(100%, 420px);
            margin: 0 auto;
        }

        #message-input, #send-button {
            min-height: 56px;
        }
        @media (min-width: 768px) {
            #message-input, #send-button {
                min-height: 60px;
            }
        }
    
        body {
            font-family: 'Noto Serif TC', 'Source Han Serif TC', 'Songti TC', serif;
            font-size: 16px;
            line-height: 1.7;
            color: #2f2a25;
            background-color: #f6f5f3;
            background-image: linear-gradient(160deg, #f6f5f3 0%, #faf9f7 45%, #fdfbf8 100%);
        }
        #webcrumbs .warm-shell,
        .warm-shell {
            background: linear-gradient(180deg, #fdfbf8 0%, #f6f5f3 60%, #faf9f7 100%);
        }
        #webcrumbs .warm-surface,
        .warm-surface {
            background: linear-gradient(160deg, rgba(253, 251, 248, 0.95) 0%, rgba(246, 245, 243, 0.95) 100%);
        }

        #webcrumbs .warm-cta,
        #webcrumbs .warm-cta-main,
        .warm-cta,
        .warm-cta-main,
        .btn-primary,
        .cta-button,
        #brand-intro-enter-btn,
        #generate-card-button {
            background: linear-gradient(135deg, #f4d7c3 0%, #e8c3ad 100%);
            color: #5b4032;
            border: 1px solid rgba(205, 175, 154, 0.6);
        }
        #webcrumbs .warm-cta:hover,
        #webcrumbs .warm-cta-main:hover,
        .warm-cta:hover,
        .warm-cta-main:hover,
        .btn-primary:hover,
        .cta-button:hover,
        #brand-intro-enter-btn:hover,
        #generate-card-button:hover {
            background: linear-gradient(135deg, #ebcdb7 0%, #dfb49a 100%);
            color: #4b3326;
        }
        #webcrumbs .font-sans,
        .font-sans {
            font-family: 'Noto Serif TC', 'Source Han Serif TC', 'Songti TC', serif;
        }

    </style>
</head>
<body class="text-[var(--text-primary)] flex items-center justify-center min-h-screen p-4">
        
        <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-K2VQTGFM"
        height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
        


    <div id="app-container" class="w-full max-w-6xl mx-auto h-screen flex flex-col">

        
        <div id="selection-view" class="flex flex-col items-center justify-center h-full view-transition">
            <div class="text-center mb-10">
                 
                
            <div class="mb-3">
                
                <svg class="w-24 h-24 mx-auto transform hover:scale-110 transition duration-300" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <radialGradient id="heartGradient" cx="50%" cy="40%" r="60%">
                            <stop offset="0%" stop-color="#ff87a4" />
                            <stop offset="100%" stop-color="#ff3f6c" />
                        </radialGradient>
                    </defs>
                    <path d="M60 100 C25 70 8 52 10 32 C12 14 26 6 40 10 C50 13 56 22 60 28 C64 22 70 13 80 10 C94 6 108 14 110 32 C112 52 95 70 60 100 Z" fill="url(#heartGradient)" stroke="#f0315a" stroke-width="6" stroke-linejoin="round" />
                </svg>
            </div>
                 <h1 class="text-4xl md:text-5xl font-semibold mb-2">貓咪談心室</h1>
                <p class="text-lg text-[var(--text-secondary)]">選一位貓咪朋友，開始你們的悄悄話時間。</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-3xl">
                <button onclick="selectMode('deep-chat')" class="group bg-[var(--bg-secondary)] p-8 rounded-2xl custom-shadow-lg hover:shadow-2xl hover:-translate-y-1.5 transition-all text-left flex items-center gap-6 relative overflow-hidden selection-mode-card" data-bubble-color="rgba(184, 172, 215, 0.55)">
                    <div class="bg-purple-100 p-4 rounded-full"><img src="{{ url_for('static', filename='grandma.jpg') }}" alt="喵奶奶春蘭" class="w-[60px] h-[60px] rounded-full object-cover shadow-sm" /></div>
                    <div class="flex-1">
                        <h2 class="text-2xl font-medium text-slate-700">深度聊聊</h2>
                        
                        <p class="text-[var(--text-secondary)] text-sm mt-2 leading-relaxed">讓溫柔的「喵奶奶春蘭」陪你深入探索內心世界，慢慢梳理思緒，你可以傳送任何想聊的心情話語給喵奶奶春蘭，若感覺聊夠了，可以按「悄悄話總結」噢！</p>
                    </div>
                </button>
                <button onclick="selectMode('quick-qa')" class="group bg-[var(--bg-secondary)] p-8 rounded-2xl custom-shadow-lg hover:shadow-2xl hover:-translate-y-1.5 transition-all text-left flex items-center gap-6 relative overflow-hidden selection-mode-card" data-bubble-color="rgba(255, 201, 130, 0.55)">
                    <div class="bg-amber-100 p-4 rounded-full"><img src="{{ url_for('static', filename='reporter.jpg') }}" alt="喵記者馬克" class="w-[60px] h-[60px] rounded-full object-cover shadow-sm" /></div>
                    <div class="flex-1">
                        <h2 class="text-2xl font-medium text-slate-700">焦點訪談</h2>
                        
                        <p class="text-[var(--text-secondary)] text-sm mt-2 leading-relaxed">由專業的「喵記者馬克」提問 3 題至 15 題選擇題，你可以三選一作答，也可以改輸入文字傳送答案；若感覺聊夠了可以按「悄悄話總結」，讓馬克陪你快速釐清當下的心情與狀況。</p>
                    </div>
                </button>
            </div>
            
            <div class="mt-8 text-center">
                <a href="{{ url_for('upload_health', reupload=1) }}" class="inline-flex items-center gap-3 px-6 py-2.5 rounded-full text-base font-semibold text-gray-700 border border-transparent bg-white/90 shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all" style="font-size: 90%;">
                    <span class="flex items-center gap-2">🐾 我要重新上傳報告</span>
                </a>
            </div>
        </div>

        
        <div id="dashboard-view" class="hidden flex-col h-full view-transition opacity-0 scale-95 w-full">
            <header class="flex items-center mb-4">
                <button onclick="confirmReturnToMenu()" class="bg-gray-100 hover:bg-gray-200 text-gray-500 p-2 rounded-full transition-all mr-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                </button>
                <div class="flex-grow">
                    <h1 id="dashboard-title" class="text-xl font-bold text-slate-700">與 喵奶奶春蘭 深度聊聊</h1>
                    <div id="progress-bar-container" class="w-full bg-gray-200 rounded-full h-1.5 mt-1.5">
                        <div id="progress-bar-fill" class="bg-[var(--accent-primary)] h-1.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
            </header>
            <main id="main-grid" class="grid grid-cols-1 gap-6 flex-grow min-h-0">
                
                <div id="chat-panel" class="bg-[var(--bg-secondary)] rounded-2xl custom-shadow flex flex-col h-full max-h-[calc(100vh-120px)]">
                    <div id="chat-history" class="flex-grow p-4 space-y-4 overflow-y-auto scroll-smooth">
                        
                    </div>
                    <div id="quick-replies-container" class="p-2 flex flex-wrap gap-2 justify-center border-t border-gray-100">
                        
                    </div>
                    
                    <p id="summary-reminder" class="px-4 text-center text-[var(--text-secondary)] text-xs tracking-wide hidden-section">當你聊夠了，可以點「悄悄話總結」結束對話並生成圖卡</p>
                    <div class="p-4 border-t border-gray-100">
                        
                        <div class="flex items-center gap-3 chat-input-wrapper w-full">
                            
                            <textarea id="message-input" rows="1" maxlength="1000" class="w-full p-3 border-gray-200 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--accent-primary)] transition-all" placeholder="說點什麼吧... 按右邊按鈕送出訊息"></textarea>
                            
                            <button onclick="sendMessage()" class="paw-button" id="send-button" type="button" aria-label="送出訊息">
                                <span id="send-icon" class="send-icon paw">🐾</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="px-4 pb-4">
                        <div class="bg-amber-100 border border-amber-300 text-amber-900 rounded-xl px-4 py-3 text-xs text-center leading-relaxed">
                            <strong>【特別提醒】</strong> 本測驗僅為娛樂與參考，並非醫療建議。若有任何身心困擾，請尋求專業協助。
                        </div>
                    </div>
                    
                </div>
                
                <div id="dashboard-panel" class="hidden rounded-2xl overflow-y-auto h-full max-h-[calc(100vh-120px)] space-y-6 scroll-smooth">
                    <div class="bg-white p-6 rounded-2xl custom-shadow card-paw-decoration summary-card">
                         <h3 class="font-semibold mb-2 text-slate-600 flex items-center gap-2">
                            <svg class="w-5 h-5 text-gray-400" viewBox="0 0 24 24" fill="currentColor"><path d="M14,2H6C4.9,2,4,2.9,4,4v16c0,1.1,0.9,2,2,2h12c1.1,0,2-0.9,2-2V8L14,2z M12,19c-1.66,0-3-1.34-3-3s1.34-3,3-3s3,1.34,3,3 S13.66,19,12,19z M15,9H9V4h6V9z"/></svg>
                            悄悄話總結
                        </h3>
                        <div id="report-summary" class="text-[var(--text-secondary)] text-sm prose max-w-none prose-p:my-1">完成對話後，這裡會出現一份暖心總結。</div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    
    <div id="brand-intro-modal" class="fixed inset-0 brand-intro-modal flex items-center justify-center p-6 z-50 hidden opacity-0 transition-opacity duration-300">
        <div id="brand-intro-card" class="brand-intro-card rounded-3xl shadow-2xl overflow-hidden transform scale-95 transition-transform duration-300 relative">
            <button type="button" id="brand-intro-close" class="absolute top-4 right-4 bg-white/80 hover:bg-white text-gray-600 rounded-full p-2 shadow-md transition" aria-label="關閉品牌介紹視窗">×</button>
            <img src="{{ url_for('static', filename='window.jpg') }}" alt="品牌介紹">
            <div class="p-6 bg-white/90 backdrop-blur-sm">
                <button id="brand-intro-enter-btn" class="w-full bg-gradient-to-r from-orange-400 to-orange-500 text-white font-semibold py-3 rounded-full shadow-lg hover:shadow-xl transition">進入貓咪談心室</button>
            </div>
        </div>
    </div>

    
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center p-4 z-50 hidden transition-opacity duration-300 opacity-0">
        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-sm w-full transform transition-transform duration-300 scale-95">
            <h2 class="text-xl font-bold mb-4 text-slate-800">確定要離開嗎？</h2>
            <p class="text-slate-600 mb-6">現在離開的話，這次的對話紀錄會消失喔。</p>
            <div class="flex justify-end gap-3">
                <button id="cancel-return-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-5 rounded-lg hover:bg-gray-300 transition-all">繼續聊</button>
                <button id="confirm-return-btn" class="bg-red-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-red-600 transition-all">確定離開</button>
            </div>
        </div>
    </div>

    
    <div id="result-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center p-4 z-50 hidden transition-opacity duration-300 opacity-0">
        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-sm w-full text-center transform transition-transform duration-300 scale-95">
            <div class="mx-auto bg-purple-100 w-16 h-16 rounded-full flex items-center justify-center mb-4">
                <svg class="w-10 h-10 text-purple-500" viewBox="0 0 24 24" fill="currentColor"><path d="M12,2C6.48,2,2,6.48,2,12s4.48,10,10,10s10-4.48,10-10S17.52,2,12,2z M16.71,9.29l-6.59,6.59c-0.39,0.39-1.02,0.39-1.41,0 L6,13.17c-0.39-0.39-0.39-1.02,0-1.41s1.02-0.39,1.41,0L9,12.36l5.88-5.88c0.39-0.39,1.02-0.39,1.41,0S17.1,8.9,16.71,9.29z"/></svg>
            </div>
            <h2 class="text-2xl font-bold mb-3 text-slate-800">悄悄話已完成 ✨</h2>
            <p class="text-slate-600 mb-6">我已經將我們的對話整理好了，快來看看吧！</p>
            <button id="close-result-modal" class="bg-[var(--accent-primary)] text-white font-semibold py-2.5 px-8 rounded-lg hover:bg-[var(--accent-primary-hover)] transition-all w-full">我知道了</button>
        </div>
    </div>

    
    <div id="magic-overlay" class="magic-overlay" role="status" aria-live="polite">
        <div id="box-animation" class="magic-overlay-card">
            <div class="magic-animation-frame">
                <svg class="magic-animation-svg" viewBox="0 0 600 300" xmlns="http://www.w3.org/2000/svg" role="presentation" aria-hidden="true">
                    <rect x="0" y="0" width="600" height="300" fill="#f0f4f8" />
                    <circle cx="500" cy="60" r="30" fill="#fff9c4" opacity="0.6" />
                    <g class="cat-tail">
                        <path d="M165 280 Q 110 280 100 230 T 130 180" stroke="var(--cat-color)" stroke-width="22" fill="none" stroke-linecap="round" />
                    </g>
                    <g class="cat-lower-body">
                        <path d="M155 300 Q 150 260 220 230 Q 290 260 285 300" fill="var(--cat-color)" />
                    </g>
                    <g class="cat-body">
                        <ellipse cx="220" cy="270" rx="60" ry="70" fill="var(--cat-color)" />
                    </g>
                    <g class="cat-arm-static">
                        <path d="M220 260 L 175 285" stroke="var(--cat-color)" stroke-width="25" stroke-linecap="round" fill="none" />
                        <circle cx="175" cy="285" r="15" fill="var(--cat-light)" />
                    </g>
                    <g class="cat-arm-active">
                        <path d="M220 260 L 320 230" stroke="var(--cat-color)" stroke-width="30" stroke-linecap="round" fill="none" />
                        <circle cx="320" cy="230" r="18" fill="var(--cat-light)" />
                        <circle cx="320" cy="232" r="7" fill="var(--paw-pink)" />
                        <circle cx="312" cy="224" r="3.5" fill="var(--paw-pink)" />
                        <circle cx="320" cy="220" r="3.5" fill="var(--paw-pink)" />
                        <circle cx="328" cy="224" r="3.5" fill="var(--paw-pink)" />
                    </g>
                    <rect x="0" y="280" width="600" height="20" fill="var(--table-color)" />
                    <g class="cat-head">
                        <path d="M178 170 Q 160 115 205 150 Q 215 165 212 180 L 178 180 Z" fill="var(--cat-color)" />
                        <path d="M262 170 Q 280 115 235 150 Q 225 165 228 180 L 262 180 Z" fill="var(--cat-color)" />
                        <circle cx="220" cy="190" r="45" fill="var(--cat-color)" />
                        <g>
                            <circle cx="205" cy="185" r="8" fill="white" />
                            <circle cx="207" cy="185" r="4" fill="black" />
                            <circle cx="235" cy="185" r="8" fill="white" />
                            <circle cx="237" cy="185" r="4" fill="black" />
                        </g>
                        <path d="M215 200 L 225 200 L 220 205 Z" fill="#f48fb1" />
                        <line x1="185" y1="195" x2="150" y2="185" stroke="#444" stroke-width="1.5" />
                        <line x1="185" y1="202" x2="145" y2="202" stroke="#444" stroke-width="1.5" />
                        <line x1="185" y1="209" x2="150" y2="219" stroke="#444" stroke-width="1.5" />
                        <line x1="255" y1="195" x2="290" y2="185" stroke="#444" stroke-width="1.5" />
                        <line x1="255" y1="202" x2="295" y2="202" stroke="#444" stroke-width="1.5" />
                        <line x1="255" y1="209" x2="290" y2="219" stroke="#444" stroke-width="1.5" />
                    </g>
                    <g class="target-box box-active" id="boxGroup">
                        <rect x="320" y="185" width="120" height="95" fill="var(--box-color)" stroke="var(--box-dark)" stroke-width="2" rx="4" />
                        <line x1="320" y1="195" x2="440" y2="195" stroke="var(--box-dark)" stroke-width="1" />
                        <rect x="330" y="225" width="100" height="25" fill="rgba(255,255,255,0.8)" rx="2" />
                        <text id="targetText" x="380" y="242" font-size="12" fill="#5d4037" font-weight="900" text-anchor="middle" style="user-select: none;">準備中</text>
                    </g>
                </svg>
            </div>
            <p class="magic-message">生成圖卡約需20~30秒。先來摸摸貓咪吧！</p>
        </div>
        <div id="pet-animation" class="magic-overlay-card petting-overlay hidden">
        <div id="pet-container" class="petting-container">
            <canvas id="petCanvas"></canvas>
        </div>
            <p class="magic-message">生成圖卡約需20~30秒。先來摸摸貓咪吧！</p>
        </div>
    </div>


    <script>
        // --- DOM Elements ---
        const healthReportData = {{ latest_health_report|tojson|default('null', true)|safe }};
        const selectionView = document.getElementById('selection-view');
        const dashboardView = document.getElementById('dashboard-view');
        const dashboardPanel = document.getElementById('dashboard-panel');
        const dashboardTitle = document.getElementById('dashboard-title');
        const chatHistory = document.getElementById('chat-history');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const sendIcon = document.getElementById('send-icon');
        const quickRepliesContainer = document.getElementById('quick-replies-container');
        const brandIntroModal = document.getElementById('brand-intro-modal');
        const brandIntroCard = document.getElementById('brand-intro-card');
        const brandIntroEnterBtn = document.getElementById('brand-intro-enter-btn');
        const brandIntroCloseBtn = document.getElementById('brand-intro-close');
        const reportSummary = document.getElementById('report-summary');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmReturnBtn = document.getElementById('confirm-return-btn');
        const cancelReturnBtn = document.getElementById('cancel-return-btn');
        const resultModal = document.getElementById('result-modal');
        const closeResultModalBtn = document.getElementById('close-result-modal');
        const progressBarFill = document.getElementById('progress-bar-fill');
        const chatPanel = document.getElementById('chat-panel');
        const mainGrid = document.getElementById('main-grid');
        const magicOverlay = document.getElementById('magic-overlay');
        const magicAnimationSvg = document.querySelector('.magic-animation-svg');
        const targetTextElement = document.getElementById('targetText');
        const boxGroup = document.getElementById('boxGroup');
        const boxAnimation = document.getElementById('box-animation');
        const petAnimation = document.getElementById('pet-animation');
        const petContainer = document.getElementById('pet-container');
        const petCanvas = document.getElementById('petCanvas');
        const boxMessage = boxAnimation ? boxAnimation.querySelector('.magic-message') : null;
        const petMessage = petAnimation ? petAnimation.querySelector('.magic-message') : null;
        const selectionModeCards = document.querySelectorAll('.selection-mode-card');
        const selectionBubbleEffects = [];
        let messageLengthAlertShown = false;

        const appState = {
            mode: null,
            conversationHistory: [],
            isLoading: false,
            isAnalysisReady: false,
            isReportGenerated: false,
            turnCount: 0,
            confidence: 0,
            qaQuestionCount: 0,
            isMaxQaReached: false,
            hasShownMaxQaReminder: false
        };

        const GRANDMA_OPENERS = [
            "孩子啊，我坐在這裡呢。慢慢說，不用急，奶奶都在聽。",
            "來，靠過來一點。你心裡有什麼風聲，我都願意陪你一起聽。",
            "嗯，小寶貝，看起來有什麼掛在心上？跟奶奶說說，我在這裡。",
            "別擔心，今天的時間都是你的。想從哪裡開始，我都陪你。",
            "孩子，你的眉頭好像藏著故事。說給奶奶聽聽，好嗎？",
            "我在呢，別怕打擾我。你願意的話，我想聽你心裡那些沒說出口的話。",
            "走吧，我們一起坐下。你一句、我一句，把心裡的事情慢慢攤開。",
            "孩子，你今天心裡的天氣如何？下雨也好，晴天也好，我都在。",
            "你看起來好像撐了很久。來，跟奶奶說說，你累在哪裡？",
            "沒關係，無論你現在什麼心情，都可以帶來。我會好好地聽。"
        ];
        const NEGATIVE_HINTS = ["不公", "憂", "沮", "消極", "焦", "煩", "難過", "壓", "怒", "悲", "痛", "恐", "怕", "懼", "厭", "困", "絕", "孤單"];
        const POSITIVE_HINTS = ["晴", "喜", "樂", "開心", "暖", "安", "靜", "順", "好", "滿", "感謝", "期待", "幸福"];

        const NEGATIVE_MAGIC_MESSAGES = [
            "幫你把壞情緒掃走",
            "有點煩？貓咪先幫你拍掉",
            "情緒有點亂？讓貓咪幫你撥下去",
            "讓貓咪出手，把煩的先撥走"
        ];
        const POSITIVE_MAGIC_MESSAGES = [
            "先來摸摸貓咪，圖卡馬上送到",
            "先陪貓咪呼嚕一下，心情慢慢暖起來",
            "先來擼一會兒貓咪，放鬆一下",
            "先讓貓咪陪你放鬆，等圖卡出爐"
        ];
        const MAGIC_WAIT_PREFIX = "生成圖卡約需20~30秒。";

        const MAX_KEYWORD_CYCLE = 3;
        let magicKeywords = ['壞情緒'];
        let magicKeywordIndex = 0;
        let magicKeywordInterval = null;

        function sanitizeKeyword(value) {
            if (!value && value !== 0) return '';
            return String(value).trim();
        }

        function isNegativeText(value) {
            if (!value) return false;
            const normalized = value.replace(/\s+/g, '');
            return NEGATIVE_HINTS.some(hint => normalized.includes(hint));
        }

        function isPositiveText(value) {
            if (!value) return false;
            const normalized = value.replace(/\s+/g, '');
            return POSITIVE_HINTS.some(hint => normalized.includes(hint));
        }

        function extractKeywordsFromSummary(summary) {
            if (!summary) return [];
            const cleaned = summary.replace(/[\n\r]+/g, ' ');
            const bracketMatches = cleaned.match(/[「『【](.+?)[」』】]/g) || [];
            const keywords = bracketMatches.map(match => match.slice(1, -1).trim()).filter(Boolean);
            const plainWords = cleaned.split(/[,，。；、\s]+/).filter(Boolean);
            return [...keywords, ...plainWords].slice(0, MAX_KEYWORD_CYCLE * 2);
        }

        function gatherMagicKeywords() {
            const data = window.currentReportData || {};
            const negatives = [];
            const positives = [];

            const pushNegative = (value) => {
                const text = sanitizeKeyword(value);
                if (!text) return;
                if (!negatives.includes(text) && isNegativeText(text)) {
                    negatives.push(text);
                }
            };

            const pushPositive = (value) => {
                const text = sanitizeKeyword(value);
                if (!text) return;
                if (isPositiveText(text) && !positives.includes(text)) {
                    positives.push(text);
                }
            };

            const tryPush = (value) => {
                const text = sanitizeKeyword(value);
                if (!text) return;
                if (isNegativeText(text)) {
                    pushNegative(text);
                } else {
                    pushPositive(text);
                }
            };

            if (Array.isArray(data.keywords)) {
                for (const candidate of data.keywords) {
                    tryPush(candidate);
                    if (negatives.length >= MAX_KEYWORD_CYCLE) break;
                }
            } else if (typeof data.keywords === 'string') {
                tryPush(data.keywords);
            }

            if (negatives.length < MAX_KEYWORD_CYCLE) {
                const summaryExtras = extractKeywordsFromSummary(data.summary || '');
                for (const extra of summaryExtras) {
                    tryPush(extra);
                    if (negatives.length >= MAX_KEYWORD_CYCLE) break;
                }
            }

            const hasNegative = negatives.length > 0;
            const hasPositiveOnly = !hasNegative && positives.length > 0;
            const fallbackKeywords = hasNegative ? negatives : ['壞情緒'];
            return {
                keywords: fallbackKeywords,
                hasNegative,
                hasPositiveOnly: hasPositiveOnly && !hasNegative
            };
        }

        function applyKeywordToBox(keyword) {
            if (!targetTextElement) return;
            const value = (keyword || '壞情緒').replace(/\s+/g, '');
            const truncated = value.slice(0, 12);
            const lines = [];
            if (!truncated.length) {
                lines.push('壞');
            } else {
                if (truncated.length <= 6) {
                    lines.push(truncated);
                } else {
                    lines.push(truncated.slice(0, 6));
                    lines.push(truncated.slice(6));
                }
            }
            targetTextElement.innerHTML = lines
                .map((segment, index) => `<tspan x="380" dy="${index === 0 ? 0 : 14}">${segment}</tspan>`)
                .join('');
            if (truncated.length >= 12) {
                targetTextElement.setAttribute('font-size', '10');
            } else if (truncated.length >= 8) {
                targetTextElement.setAttribute('font-size', '12');
            } else {
                targetTextElement.setAttribute('font-size', '14');
            }
        }

        function stopMagicKeywordCycle() {
            if (magicKeywordInterval) {
                clearInterval(magicKeywordInterval);
                magicKeywordInterval = null;
            }
        }

        function startMagicKeywordCycle(keywords) {
            stopMagicKeywordCycle();
            magicKeywords = (keywords && keywords.length) ? keywords : ['壞情緒'];
            magicKeywordIndex = 0;
            applyKeywordToBox(magicKeywords[magicKeywordIndex]);
            if (magicKeywords.length > 1) {
                magicKeywordInterval = window.setInterval(() => {
                    magicKeywordIndex = (magicKeywordIndex + 1) % magicKeywords.length;
                    applyKeywordToBox(magicKeywords[magicKeywordIndex]);
                }, 2200);
            }
        }

        let pettingAnimation = { start: () => {}, stop: () => {} };
        function startPettingAnimation() {
            pettingAnimation.start();
        }
        function stopPettingAnimation() {
            pettingAnimation.stop();
        }

        let lastMagicMessage = '';
        function pickMagicMessage(isNegative) {
            const list = isNegative ? NEGATIVE_MAGIC_MESSAGES : POSITIVE_MAGIC_MESSAGES;
            if (!list.length) {
                return MAGIC_WAIT_PREFIX;
            }
            let choice = list[Math.floor(Math.random() * list.length)];
            if (list.length > 1) {
                let attempts = 0;
                while (choice === lastMagicMessage && attempts < 5) {
                    choice = list[Math.floor(Math.random() * list.length)];
                    attempts += 1;
                }
            }
            lastMagicMessage = choice;
            return `${MAGIC_WAIT_PREFIX}${choice}`;
        }

        function setMagicMessage(isNegative) {
            const message = pickMagicMessage(isNegative);
            if (boxMessage) {
                boxMessage.textContent = message;
            }
            if (petMessage) {
                petMessage.textContent = message;
            }
        }

        function showBoxAnimation(keywords) {
            petAnimation.classList.add('hidden');
            petAnimation.classList.remove('active');
            boxAnimation.classList.remove('hidden');
            boxAnimation.classList.add('active');
            if (magicOverlay) {
                magicOverlay.classList.add('orange-mode');
            }
            setMagicMessage(true);
            startMagicKeywordCycle(keywords);
            stopPettingAnimation();
        }

        function showPetAnimation() {
            boxAnimation.classList.add('hidden');
            boxAnimation.classList.remove('active');
            petAnimation.classList.remove('hidden');
            petAnimation.classList.add('active');
            if (magicOverlay) {
                magicOverlay.classList.remove('orange-mode');
            }
            setMagicMessage(false);
            stopMagicKeywordCycle();
            startPettingAnimation();
        }

        function resetMagicAnimation() {
            if (!magicAnimationSvg) return;
            magicAnimationSvg.classList.remove('magic-animate');
            void magicAnimationSvg.offsetWidth;
            magicAnimationSvg.classList.add('magic-animate');
            if (boxGroup) {
                boxGroup.classList.remove('box-active');
                void boxGroup.offsetWidth;
                boxGroup.classList.add('box-active');
            }
            const {keywords, hasNegative, hasPositiveOnly} = gatherMagicKeywords();
            const shouldShowBox = hasNegative || (!hasPositiveOnly && !hasNegative);
            if (shouldShowBox) {
                showBoxAnimation(keywords);
            } else {
                showPetAnimation();
            }
        }

        function refreshMagicScene() {
            resetMagicAnimation();
        }

        function createPettingAnimation() {
            if (!petCanvas || !petContainer) {
                return { start: () => {}, stop: () => {} };
            }
            const ctx = petCanvas.getContext('2d');
            let width = 0;
            let height = 0;
            let touchX = 0;
            let touchY = 0;
            let handX = 0;
            let handY = 0;
            let scale = 1.35;
            let isTouching = false;
            let isActuallyPetting = false;
            let isBiting = false;
            let petDuration = 0;
            let biteCooldown = 0;
            let handOffset = { x: 0, y: 0 };
            let animId = null;
            let listenersAdded = false;
            const cat = {
                x: 0,
                y: 0,
                color: '#8e8e8e',
                tailAngle: 0
            };

            function resize() {
                width = petCanvas.clientWidth;
                height = petCanvas.clientHeight;
                petCanvas.width = width;
                petCanvas.height = height;
                cat.x = width / 2;
                cat.y = height / 2 + 30;
                touchX = width / 2;
                touchY = height + 100;
                handX = touchX;
                handY = touchY;
            }

            function updatePos(e) {
                if (isBiting) return;
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                const rect = petCanvas.getBoundingClientRect();
                const relativeX = clientX - rect.left;
                const relativeY = clientY - rect.top;
                const centerX = width / 2;
                const limitRangeX = 180;

                if (relativeX < centerX - limitRangeX) touchX = centerX - limitRangeX;
                else if (relativeX > centerX + limitRangeX) touchX = centerX + limitRangeX;
                else touchX = relativeX;

                const maxYLimit = cat.y - 100 * scale;
                if (relativeY < maxYLimit) touchY = maxYLimit;
                else if (relativeY > height + 100) touchY = height + 100;
                else touchY = relativeY;

                isTouching = true;
                const dx = Math.abs(touchX - cat.x);
                const dy = Math.abs(touchY - cat.y);
                isActuallyPetting = (dx < 150 * scale && dy < 120 * scale) && biteCooldown <= 0;
            }

            function handleStart(e) {
                updatePos(e);
                if (isActuallyPetting && !isBiting) {
                    createEmoji('❤️');
                }
            }

            function handleEnd() {
                isTouching = false;
                isActuallyPetting = false;
                petDuration = 0;
            }

            function createEmoji(icon) {
                const emoji = document.createElement('div');
                emoji.innerHTML = icon;
                emoji.className = icon === '❤️' ? 'heart' : 'feedback-emoji';
                emoji.style.left = `${touchX - 12}px`;
                emoji.style.top = `${touchY - 12}px`;
                petContainer.appendChild(emoji);
                setTimeout(() => emoji.remove(), 1200);
            }

            function triggerBite() {
                isBiting = true;
                isActuallyPetting = false;
                createEmoji('💢');
                createEmoji('⚡');
                handOffset.x = (Math.random() - 0.5) * 40;
                handOffset.y = 50;
                setTimeout(() => {
                    isBiting = false;
                    petDuration = 0;
                    biteCooldown = 120;
                    handOffset.x = 0;
                    handOffset.y = 0;
                }, 600);
            }

            function drawCat() {
                const shake = (isActuallyPetting || isBiting) ? Math.sin(Date.now() * 0.05) * 2 : 0;
                ctx.save();
                ctx.translate(cat.x + shake, cat.y);
                ctx.scale(scale, scale);

                ctx.save();
                ctx.translate(80, 20);
                cat.tailAngle = Math.sin(Date.now() * 0.003) * 0.5;
                ctx.rotate(cat.tailAngle);
                ctx.lineWidth = 22;
                ctx.lineCap = 'round';
                ctx.strokeStyle = cat.color;
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.quadraticCurveTo(50, -50, 85, -15);
                ctx.stroke();
                ctx.restore();

                ctx.fillStyle = cat.color;
                ctx.beginPath();
                ctx.ellipse(10, 20, 110, 70, 0, 0, Math.PI * 2);
                ctx.fill();

                ctx.fillStyle = cat.color;
                ctx.beginPath();
                ctx.ellipse(-45, 75, 28, 16, -0.1, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.ellipse(-5, 80, 28, 16, 0.05, 0, Math.PI * 2);
                ctx.fill();

                const hX = -85;
                const hY = -40;
                ctx.fillStyle = cat.color;
                ctx.beginPath();
                ctx.arc(hX, hY, 60, 0, Math.PI * 2);
                ctx.fill();

                ctx.fillStyle = cat.color;
                ctx.beginPath();
                ctx.moveTo(hX - 55, hY - 20);
                ctx.lineTo(hX - 45, hY - 85);
                ctx.lineTo(hX - 5, hY - 55);
                ctx.fill();
                ctx.beginPath();
                ctx.moveTo(hX + 5, hY - 55);
                ctx.lineTo(hX + 45, hY - 85);
                ctx.lineTo(hX + 55, hY - 20);
                ctx.fill();

                ctx.strokeStyle = '#333';
                ctx.lineWidth = 3;
                ctx.lineCap = 'round';
                if (isActuallyPetting && !isBiting) {
                    ctx.beginPath();
                    ctx.arc(hX - 25, hY - 5, 8, 0.1 * Math.PI, 0.9 * Math.PI);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.arc(hX + 25, hY - 5, 8, 0.1 * Math.PI, 0.9 * Math.PI);
                    ctx.stroke();
                } else if (isBiting) {
                    ctx.beginPath();
                    ctx.moveTo(hX - 35, hY - 10);
                    ctx.lineTo(hX - 15, hY);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(hX + 15, hY);
                    ctx.lineTo(hX + 35, hY - 10);
                    ctx.stroke();
                } else {
                    ctx.fillStyle = '#333';
                    ctx.beginPath();
                    ctx.arc(hX - 25, hY - 5, 5, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.beginPath();
                    ctx.arc(hX + 25, hY - 5, 5, 0, Math.PI * 2);
                    ctx.fill();
                }

                if (!isBiting) {
                    ctx.fillStyle = '#FFB6C1';
                    ctx.beginPath();
                    ctx.moveTo(hX - 6, hY + 8);
                    ctx.lineTo(hX + 6, hY + 8);
                    ctx.lineTo(hX, hY + 14);
                    ctx.closePath();
                    ctx.fill();
                    ctx.strokeStyle = '#333';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(hX, hY + 14);
                    ctx.quadraticCurveTo(hX - 5, hY + 20, hX - 10, hY + 15);
                    ctx.moveTo(hX, hY + 14);
                    ctx.quadraticCurveTo(hX + 5, hY + 20, hX + 10, hY + 15);
                    ctx.stroke();
                } else {
                    ctx.fillStyle = '#333';
                    ctx.beginPath();
                    ctx.ellipse(hX, hY + 18, 10, 14, 0, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#ff99aa';
                    ctx.beginPath();
                    ctx.ellipse(hX, hY + 22, 6, 6, 0, 0, Math.PI * 2);
                    ctx.fill();
                }

                ctx.strokeStyle = 'rgba(0, 0, 0, 0.2)';
                ctx.lineWidth = 1.2;
                ctx.beginPath();
                ctx.moveTo(hX - 15, hY + 10);
                ctx.lineTo(hX - 70, hY + 2);
                ctx.moveTo(hX - 15, hY + 13);
                ctx.lineTo(hX - 75, hY + 18);
                ctx.moveTo(hX - 15, hY + 16);
                ctx.lineTo(hX - 70, hY + 34);
                ctx.moveTo(hX + 15, hY + 10);
                ctx.lineTo(hX + 70, hY + 2);
                ctx.moveTo(hX + 15, hY + 13);
                ctx.lineTo(hX + 75, hY + 18);
                ctx.moveTo(hX + 15, hY + 16);
                ctx.lineTo(hX + 70, hY + 34);
                ctx.stroke();

                ctx.restore();
            }

            function drawHand() {
                const rootX = width / 2;
                const rootY = height + 100;
                const targetX = touchX + handOffset.x;
                const targetY = touchY + handOffset.y;
                handX += (targetX - handX) * 0.15;
                handY += (targetY - handY) * 0.15;

                const skinColor = '#f5d1c1';
                const sleeveColor = '#ffffff';

                ctx.save();
                ctx.translate(handX, handY);
                ctx.fillStyle = isBiting ? '#ffb0a0' : skinColor;
                ctx.beginPath();
                ctx.ellipse(0, 30, 28, 40, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.ellipse(0, 15, 36, 45, 0, 0, Math.PI * 2);
                ctx.fill();

                const fL = [35, 52, 58, 48];
                const fA = [0.3, 0.1, -0.05, -0.25];
                const fX = [24, 10, -6, -22];
                const fY = [-8, -22, -25, -20];

                for (let i = 0; i < 4; i++) {
                    ctx.save();
                    ctx.translate(fX[i], fY[i]);
                    ctx.rotate(fA[i]);
                    ctx.beginPath();
                    ctx.rect(-8.5, -fL[i], 17, fL[i] + 30);
                    ctx.fill();
                    ctx.beginPath();
                    ctx.arc(0, -fL[i], 8.5, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.restore();
                }

                ctx.save();
                ctx.translate(-24, 12);
                ctx.rotate(-Math.PI / 2.3);
                ctx.beginPath();
                ctx.ellipse(0, 5, 12, 15, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.rect(-11, -26, 22, 31);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(0, -26, 11, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
                ctx.restore();

                ctx.save();
                ctx.beginPath();
                ctx.lineWidth = 80;
                ctx.lineCap = 'round';
                ctx.strokeStyle = sleeveColor;
                ctx.moveTo(rootX + (handX - rootX) * 0.2, rootY);
                ctx.quadraticCurveTo(handX, handY + 110, handX, handY + 45);
                ctx.stroke();

                ctx.fillStyle = sleeveColor;
                ctx.beginPath();
                ctx.ellipse(handX, handY + 45, 46, 22, 0, 0, Math.PI * 2);
                ctx.fill();

                ctx.strokeStyle = '#eeeeee';
                ctx.lineWidth = 2;
                for (let i = -30; i <= 30; i += 10) {
                    ctx.beginPath();
                    ctx.moveTo(handX + i, handY + 35);
                    ctx.lineTo(handX + i, handY + 55);
                    ctx.stroke();
                }
                ctx.restore();
            }

            function loop() {
                ctx.clearRect(0, 0, width, height);
                ctx.fillStyle = '#e2e8f0';
                ctx.fillRect(0, cat.y + 75 * scale, width, height);
                drawCat();
                drawHand();

                if (isActuallyPetting) {
                    petDuration++;
                    if (petDuration > 100 && Math.random() < (petDuration / 10000)) {
                        triggerBite();
                    }
                    if (Math.random() > 0.94) {
                        createEmoji('❤️');
                    }
                } else {
                    if (petDuration > 0) {
                        petDuration -= 0.5;
                    }
                }

                if (biteCooldown > 0) {
                    biteCooldown--;
                }

                animId = requestAnimationFrame(loop);
            }

            function addListeners() {
                if (listenersAdded) return;
                listenersAdded = true;
                const preventDefault = (e) => { e.preventDefault(); };
                petCanvas.addEventListener('mousedown', handleStart);
                petCanvas.addEventListener('touchstart', (e) => { preventDefault(e); handleStart(e); }, { passive: false });
                window.addEventListener('mouseup', handleEnd);
                window.addEventListener('touchend', handleEnd);
                window.addEventListener('mousemove', updatePos);
                window.addEventListener('touchmove', (e) => { preventDefault(e); updatePos(e); }, { passive: false });
            }

            return {
                start() {
                    if (animId) return;
                    resize();
                    addListeners();
                    loop();
                },
                stop() {
                    if (!animId) return;
                    cancelAnimationFrame(animId);
                    animId = null;
                    ctx.clearRect(0, 0, width, height);
                }
            };
        }

        pettingAnimation = createPettingAnimation();

        function pickGrandmaOpening() {
            if (!GRANDMA_OPENERS.length) {
                return "孩子啊，你好呀。我是喵奶奶春蘭，慢慢說，我都在這裡。";
            }
            const idx = Math.floor(Math.random() * GRANDMA_OPENERS.length);
            return GRANDMA_OPENERS[idx];
        }

        function createSelectionBubbleEffect(card) {
            const container = document.createElement('div');
            container.className = 'selection-bubble-container';
            card.appendChild(container);

            const color = card.dataset.bubbleColor || 'rgba(209, 196, 233, 0.45)';
            const minSize = Number(card.dataset.bubbleMin || 26);
            const maxSize = Number(card.dataset.bubbleMax || 72);
            const minDuration = Number(card.dataset.bubbleDurationMin || 5);
            const maxDuration = Number(card.dataset.bubbleDurationMax || 11);
            const spawnInterval = Number(card.dataset.bubbleInterval || 200);
            const initialCount = Math.max(1, Number(card.dataset.bubbleInitial || 18));

            let intervalId = null;
            let running = false;

            const spawnBubble = (isInitial = false) => {
                if (!document.body.contains(card)) return;
                const bubble = document.createElement('span');
                bubble.className = 'selection-bubble';

                const size = Math.random() * (maxSize - minSize) + minSize;
                bubble.style.width = `${size}px`;
                bubble.style.height = `${size}px`;
                bubble.style.left = `${Math.random() * 100}%`;

                const duration = Math.random() * (maxDuration - minDuration) + minDuration;
                bubble.style.animationDuration = `${duration}s`;
                const delay = isInitial ? Math.random() * 1.2 : Math.random() * 1.8;
                bubble.style.animationDelay = `${delay}s`;

                bubble.style.backgroundColor = color;
                bubble.style.setProperty('--bubble-opacity', (Math.random() * 0.35 + 0.35).toFixed(2));

                bubble.addEventListener('animationend', () => bubble.remove());
                container.appendChild(bubble);
                return bubble;
            };

            const start = () => {
                if (running) return;
                running = true;
                container.innerHTML = '';
                const firstBubble = spawnBubble(false);
                if (firstBubble) {
                    firstBubble.style.animationDelay = '0s';
                }
                for (let i = 1; i < initialCount; i++) {
                    spawnBubble(true);
                }
                intervalId = window.setInterval(() => spawnBubble(false), spawnInterval);
            };

            const stop = () => {
                if (!running) return;
                running = false;
                if (intervalId !== null) {
                    window.clearInterval(intervalId);
                    intervalId = null;
                }
                container.innerHTML = '';
            };

            return { start, stop };
        }

        function toggleSelectionBubbles(shouldRun) {
            selectionBubbleEffects.forEach(effect => {
                if (!effect) return;
                if (shouldRun) {
                    effect.start();
                } else {
                    effect.stop();
                }
            });
        }

        function showBrandIntroModal() {
            if (!brandIntroModal || !brandIntroCard) return;
            brandIntroModal.classList.remove('hidden');
            requestAnimationFrame(() => {
                brandIntroModal.classList.remove('opacity-0');
                brandIntroCard.classList.remove('scale-95');
            });
        }

        function closeBrandIntroModal() {
            if (!brandIntroModal || !brandIntroCard) return;
            brandIntroModal.classList.add('opacity-0');
            brandIntroCard.classList.add('scale-95');
            setTimeout(() => {
                if (brandIntroModal.classList.contains('opacity-0')) {
                    brandIntroModal.classList.add('hidden');
                }
            }, 300);
        }

        function initSelectionBubbleEffects() {
            selectionModeCards.forEach(card => {
                const effect = createSelectionBubbleEffect(card);
                selectionBubbleEffects.push(effect);
            });
            toggleSelectionBubbles(true);
        }

        initSelectionBubbleEffects();

        const loadingMessages = {
            'deep-chat': ["奶奶正在為你泡一杯熱茶...", "讓我想想... 哎呀，毛線球滾到哪去了？", "別急，溫暖的話語需要慢慢醞釀。"],
            'quick-qa': ["稿子正在快速編輯中！", "獨家消息！你的心情頭條即將發布！", "正在確認消息來源，請稍候..."]
        };
        const PAW_STAMP_DURATION = 600; 

        const GRANDMA_PULSE_DURATION = 800;




        const MAX_MESSAGE_CHARS = 1000;

        const grandmaAvatarUrl = "{{ url_for('static', filename='grandma.jpg') }}";
        const reportAvatarUrl = "{{ url_for('static', filename='reporter.jpg') }}";
        const userAvatarUrl = "{{ url_for('static', filename=user_avatar or 'profile01.png') }}";


        const DESKTOP_PLACEHOLDER_MESSAGE = "說點什麼吧... (Ctrl+Enter 送出)";
        const MOBILE_PLACEHOLDER_MESSAGE = "說點什麼吧... 按右邊按鈕送出訊息";
        let isDesktopDevice = false;
        let resolvedPlaceholderText = MOBILE_PLACEHOLDER_MESSAGE;

        function detectDesktopDevice() {
            try {
                if (window.matchMedia && window.matchMedia("(pointer: fine)").matches && (!navigator.maxTouchPoints || navigator.maxTouchPoints <= 1)) {
                    return true;
                }
                if (navigator.maxTouchPoints && navigator.maxTouchPoints > 1) {
                    return false;
                }
                const ua = (navigator.userAgent || "").toLowerCase();
                if (/(android|iphone|ipad|mobile|tablet)/i.test(ua)) {
                    return false;
                }
                if (/(windows|macintosh|linux|x11)/i.test(ua)) {
                    return true;
                }
            } catch (error) {
                console.warn("Device detection failed", error);
            }
            return false;
        }


        document.addEventListener('DOMContentLoaded', () => {
            isDesktopDevice = detectDesktopDevice();
            resolvedPlaceholderText = isDesktopDevice ? DESKTOP_PLACEHOLDER_MESSAGE : MOBILE_PLACEHOLDER_MESSAGE;
            messageInput.placeholder = resolvedPlaceholderText;

            if (brandIntroEnterBtn) {
                brandIntroEnterBtn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    closeBrandIntroModal();
                });
            }
            if (brandIntroCloseBtn) {
                brandIntroCloseBtn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    closeBrandIntroModal();
                });
            }
            if (brandIntroCard) {
                brandIntroCard.addEventListener('click', (event) => event.stopPropagation());
            }
            if (brandIntroModal) {
                brandIntroModal.addEventListener('click', closeBrandIntroModal);
            }
            if (healthReportData && brandIntroModal && brandIntroCard) {
                showBrandIntroModal();
            }

            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            messageInput.addEventListener('input', () => {
                if (messageInput.value.length > MAX_MESSAGE_CHARS) {
                    if (!messageLengthAlertShown) {
                        alert('Oops...字數超過1000字無法傳送唷');
                        messageLengthAlertShown = true;
                    }
                    messageInput.value = messageInput.value.slice(0, MAX_MESSAGE_CHARS);
                } else {
                    messageLengthAlertShown = false;
                }
                messageInput.style.height = 'auto';
                messageInput.style.height = (messageInput.scrollHeight) + 'px';
            });

            confirmReturnBtn.addEventListener('click', () => {
                returnToMenu();
                hideConfirmModal();
            });
            cancelReturnBtn.addEventListener('click', hideConfirmModal);
            confirmModal.addEventListener('click', (e) => {
                if(e.target === confirmModal) hideConfirmModal();
            });
            closeResultModalBtn.addEventListener('click', () => {
                hideResultModal();
            });
            resultModal.addEventListener('click', (e) => {
                if(e.target === resultModal) {
                    hideResultModal();
                }
            });
        });


        function selectMode(mode) {
            appState.mode = mode;
            toggleSelectionBubbles(false);
            resetState();
            appState.qaQuestionCount = 0;
            appState.isMaxQaReached = false;
            appState.hasShownMaxQaReminder = false;

            dashboardTitle.textContent = mode === 'deep-chat' ? '與 喵奶奶春蘭 深度聊聊' : '與 喵記者馬克 焦點訪談';
            if (mode === 'deep-chat') {
                document.body.classList.add('deep-chat-theme'); // 🟡 1006 修改：深聊模式啟用淡紫背景
            } else {
                document.body.classList.remove('deep-chat-theme'); // 🟡 1006 修改：非深聊模式還原背景
            }
            if (sendIcon) {
                if (mode === 'deep-chat') {
                    sendIcon.textContent = '🐾';
                    sendIcon.classList.remove('mic');
                    sendIcon.classList.add('paw');
                } else {
                    sendIcon.textContent = '🎙️';
                    sendIcon.classList.remove('paw');
                    sendIcon.classList.add('mic');
                }
            }

            selectionView.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                selectionView.classList.add('hidden');
                dashboardView.classList.remove('hidden');
                setTimeout(() => {
                    dashboardView.classList.remove('opacity-0', 'scale-95');
                    dashboardView.classList.add('flex');
                }, 50);
                startConversation();
            }, 400);
        }

        function returnToMenu() {
            document.body.classList.remove('deep-chat-theme'); 
            if (magicOverlay) {
                magicOverlay.classList.remove('active');
            }
            dashboardView.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                dashboardView.classList.add('hidden');
                dashboardView.classList.remove('flex');
                selectionView.classList.remove('hidden');
                setTimeout(() => {
                    selectionView.classList.remove('opacity-0', 'scale-95');
                    toggleSelectionBubbles(true);
                }, 50);
                resetState();
                resetUI();
            }, 400);
        }
        
        function confirmReturnToMenu() {
            if (appState.conversationHistory.length > 0) {
                showConfirmModal();
            } else {
                returnToMenu();
            }
        }

        function showConfirmModal() {
            confirmModal.classList.remove('hidden');
            setTimeout(() => {
                confirmModal.classList.remove('opacity-0');
                confirmModal.querySelector('div').classList.remove('scale-95');
            }, 10);
        }

        function hideConfirmModal() {
            confirmModal.classList.add('opacity-0');
            confirmModal.querySelector('div').classList.add('scale-95');
            setTimeout(() => {
                confirmModal.classList.add('hidden');
            }, 300);
        }

        function showResultModal() {
            resultModal.classList.remove('hidden');
            setTimeout(() => {
                resultModal.classList.remove('opacity-0');
                resultModal.querySelector('div').classList.remove('scale-95');
            }, 10);
        }

        function hideResultModal() {
            resultModal.classList.add('opacity-0');
            resultModal.querySelector('div').classList.add('scale-95');
            setTimeout(() => {
                resultModal.classList.add('hidden');
   
                showSummarySection();
            }, 300);
        }

        function showSummarySection() {
 
            if (chatPanel && dashboardPanel) {
                chatPanel.classList.add('hidden');
                dashboardPanel.classList.remove('hidden');
                dashboardPanel.scrollIntoView({ behavior: 'smooth' });
            }
            

            const summaryContainer = document.getElementById('report-summary').parentElement;
            

            if (!document.getElementById('generate-card-button')) {
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'mt-6 text-center';

                const generateCardBtn = document.createElement('button');
                generateCardBtn.id = 'generate-card-button';
                generateCardBtn.className = 'bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105';
                generateCardBtn.innerHTML = '🐱 點選此產生貓咪圖卡 ✨';
                generateCardBtn.addEventListener('click', () => {
                    if (magicOverlay) {
                        refreshMagicScene();
                        magicOverlay.classList.add('active');
                    }
                    generateCardBtn.disabled = true;
                    generateCardBtn.classList.add('opacity-80');
                    setTimeout(() => {
                        window.location.href = "{{ url_for('generate_card') }}";
                    }, 220);
                });

                buttonContainer.appendChild(generateCardBtn);
                summaryContainer.appendChild(buttonContainer);
            }
            const summaryReminder = document.getElementById('summary-reminder');
            if (summaryReminder) {
                const reminderMessages = {
                    'deep-chat': '奶奶會聽你慢慢說，這裡讓你可以想說什麼就說什麼。當你聊夠了，可以點「悄悄話總結」結束對話並生成圖卡',
                    'quick-qa': '當你聊夠了，可以點「悄悄話總結」結束對話並生成圖卡',
                };
                summaryReminder.textContent = reminderMessages[appState.mode] || reminderMessages['quick-qa']; 
                summaryReminder.classList.remove('hidden-section');
            }
        }
        
        function resetState() {
            Object.assign(appState, {
                conversationHistory: [], isLoading: false, isAnalysisReady: false,
                isReportGenerated: false, turnCount: 0, confidence: 0,
                qaQuestionCount: 0, isMaxQaReached: false, hasShownMaxQaReminder: false
            });
        }

        function resetUI() {
            chatHistory.innerHTML = '';
            messageInput.value = '';
            messageInput.placeholder = resolvedPlaceholderText;
            quickRepliesContainer.innerHTML = '';
            reportSummary.textContent = '完成對話後，這裡會出現一份暖心總結。';
            updateProgressBar(0);

            if (sendIcon) {
                sendIcon.textContent = '🐾';
                sendIcon.classList.remove('mic');
                sendIcon.classList.add('paw');
            }

            const existingButton = document.getElementById('generate-card-button');
            if (existingButton) {
                existingButton.parentElement.remove();
            }
            const summaryReminder = document.getElementById('summary-reminder');
            if (summaryReminder) {
                summaryReminder.classList.add('hidden-section'); 
            }
            if (magicOverlay) {
                magicOverlay.classList.remove('active'); 
                magicOverlay.classList.remove('orange-mode');
                boxAnimation.classList.remove('hidden');
                petAnimation.classList.add('hidden');
                stopMagicKeywordCycle();
                stopPettingAnimation();
            }
            
            if (chatPanel && dashboardPanel) {
                chatPanel.classList.remove('hidden');
                dashboardPanel.classList.add('hidden');
            }
        }

        function startConversation() {
            const initialUserMessage = { role: 'user', parts: [{ text: "你好" }] };
            appState.conversationHistory.push(initialUserMessage);

            if (appState.mode === 'quick-qa') {
                const initialModelMessage = {
                    nextPrompt: "你好！我是喵記者馬克，對什麼事感到好奇呢？我們來聊聊吧！",
                    quickReplies: ["工作", "健康", "人際關係"],
                };
                addMessage('gemini', initialModelMessage.nextPrompt);
                renderQuickReplies(initialModelMessage.quickReplies);
                appState.conversationHistory.push({ role: 'model', parts: [{ text: JSON.stringify(initialModelMessage) }] });

            } else {
                 const opener = pickGrandmaOpening();
                 addMessage('gemini', opener);
                 appState.conversationHistory.push({ role: 'model', parts: [{ text: JSON.stringify({nextPrompt: opener}) }] });
        }
            }
        async function sendMessage(quickReplyText = null) {
            const text = quickReplyText || messageInput.value.trim();
            if (!text || appState.isLoading) return;
            if (text.length > MAX_MESSAGE_CHARS) {
                alert('Oops...字數超過1000字無法傳送唷');
                if (!quickReplyText) {
                    messageInput.focus();
                }
                return;
            }

            sendButton.classList.add('is-sending');
            setTimeout(() => {
                sendButton.classList.remove('is-sending');
            }, PAW_STAMP_DURATION);

            addMessage('user', text);
            messageInput.value = '';
            messageInput.style.height = 'auto';
            clearQuickReplies();

            const explicitTriggerKeywords = ['總結', '回顧', '幫我總結', '聊夠了', '可以總結一下嗎', '那接下來呢', '我應該怎麼做', '怎麼辦', '怎麼做', '我準備好總結了'];
            const isExplicitTrigger = explicitTriggerKeywords.some(keyword => text.includes(keyword));

            if (isExplicitTrigger && !appState.isReportGenerated) {
                appState.isAnalysisReady = true;
                generateReport();
                return;
            }

            appState.conversationHistory.push({ role: 'user', parts: [{ text }] });
            appState.turnCount++;
            const isFinalQuickQaAnswer = appState.mode === 'quick-qa' && appState.isMaxQaReached;

            if (isFinalQuickQaAnswer) {
                if (!appState.hasShownMaxQaReminder) {
                    addMessage('gemini', "謝謝你完成所有題目啦！如果想整理這次的訪談，可以點「悄悄話總結」。");
                    appState.hasShownMaxQaReminder = true;
                }
                renderGenerateReportButton();
                return;
            }

            setLoading(true);

            try {
                const modelResponse = await callChatAPI(buildPrompt());
                handleModelResponse(modelResponse);
            } catch (error) {
                console.error("API Call Error:", error);
                addMessage('gemini', "嗚...我好像有點斷線了，可以再說一次嗎？");
            } finally {
                setLoading(false);
            }
        }


        function handleModelResponse(response) {
            if(!response || !response.nextPrompt) {
                console.error("Invalid response from model:", response);
                addMessage('gemini', "抱歉，我好像有點迷糊了，可以再問一次嗎？");
                return;
            }

            if (appState.mode === 'quick-qa' && !appState.isMaxQaReached) {
                appState.qaQuestionCount += 1;
                if (appState.qaQuestionCount >= 15) {
                    const finalPromptLabel = '【這是最後一題】';
                    if (typeof response.nextPrompt === 'string' && !response.nextPrompt.includes(finalPromptLabel)) {
                        response.nextPrompt = `${finalPromptLabel}${response.nextPrompt}`;
                    }
                    appState.isMaxQaReached = true;
                }
            }

            appState.conversationHistory.push({ role: 'model', parts: [{ text: JSON.stringify(response) }] });
            addMessage('gemini', response.nextPrompt);
            
            let progress = 0;
            if (appState.mode === 'quick-qa') {
                appState.confidence = response.confidence_0_100 || appState.confidence;
                progress = appState.confidence;
                renderQuickReplies(response.quickReplies || []);
                if (appState.confidence >= 60 && !appState.isReportGenerated) {
                    renderGenerateReportButton();
                }

            } else { // deep-chat
                progress = Math.min(90, (appState.turnCount / 5) * 100); 
                 if (appState.turnCount >= 3 && !appState.isReportGenerated) {
                    renderGenerateReportButton();
                }
            }
            updateProgressBar(progress);
        }

        function renderGenerateReportButton() {
            if (document.getElementById('generate-report-btn')) return;

            const button = document.createElement('button');
            button.id = 'generate-report-btn';
            button.className = "w-full max-w-xs mx-auto my-2 bg-green-100 hover:bg-green-200 text-sm text-green-800 font-bold py-2 px-4 rounded-full transition-all border border-green-300 shadow-sm";
            button.textContent = "✨悄悄話總結";
            button.onclick = () => {
                appState.isAnalysisReady = true;
                generateReport();
                clearQuickReplies();
            };
            quickRepliesContainer.appendChild(button);
        }

        async function generateReport() {
            if (appState.isReportGenerated) return;
            appState.isReportGenerated = true;
            setLoading(true, "正在為你整理悄悄話...");
            updateProgressBar(100);

            try {
                const reportData = await callReportAPI();
                
                if (!reportData.emotionVector || 
                    typeof reportData.emotionVector.valence !== 'number' || 
                    typeof reportData.emotionVector.arousal !== 'number' || 
                    typeof reportData.emotionVector.dominance !== 'number') {
                    throw new Error("Invalid emotionVector structure received.");
                }

                const extremeKeywords = ['恨死', '毀滅', '絕望', '暴力', '殺', '死', '痛恨', '崩潰', '瘋了'];
                let extremeCount = 0;
                const matchedKeywords = new Set();
                appState.conversationHistory
                    .filter(msg => msg.role === 'user')
                    .forEach(msg => {
                        const text = msg.parts[0].text.toLowerCase();
                        extremeKeywords.forEach(keyword => {
                            if (text.includes(keyword)) {
                                extremeCount++;
                                matchedKeywords.add(keyword);
                            }
                        });
                    });

                let emotionVector = {
                    valence: reportData.emotionVector.valence,
                    arousal: reportData.emotionVector.arousal,
                    dominance: reportData.emotionVector.dominance
                };
                const deductAmount = extremeCount > 0 ? Math.min(30, extremeCount * 10) : 0;
                if (extremeCount > 0) {
                    emotionVector.valence -= deductAmount;
                    emotionVector.arousal += deductAmount;
                    emotionVector.dominance -= deductAmount;
                }

                emotionVector = {
                    valence: Math.max(1, Math.min(100, Math.round(emotionVector.valence))),
                    arousal: Math.max(1, Math.min(100, Math.round(emotionVector.arousal))),
                    dominance: Math.max(1, Math.min(100, Math.round(emotionVector.dominance)))
                };

                const mindScore = Math.round(
                    (emotionVector.valence * 0.6) + 
                    (emotionVector.dominance * 0.3) + 
                    ((100 - Math.abs(emotionVector.arousal - 50)) * 0.1)
                );

                let bodyScore;
                if (healthReportData && typeof healthReportData.health_score === 'number' && healthReportData.health_score >= 0 && healthReportData.health_score <= 100) {
                    bodyScore = healthReportData.health_score;
                } else {
                    const warnings = Array.isArray(healthReportData?.health_warnings) ? healthReportData.health_warnings.filter(Boolean) : [];
                    bodyScore = warnings.length > 0 ? Math.round(80 - (warnings.length * 5)) : 85;
                }

                const combinedScore = Math.round((mindScore + bodyScore) / 2);

                console.log('Generated Scores:', {
                    mindScore: Math.max(0, Math.min(100, mindScore)),
                    bodyScore: Math.max(0, Math.min(100, bodyScore)),
                    combinedScore: Math.max(0, Math.min(100, combinedScore)),
                    emotionVector: emotionVector,
                    extremeLanguage: {
                        detected: extremeCount > 0,
                        matchedKeywords: Array.from(matchedKeywords),
                        deductAmount: deductAmount
                    }
                });

                const finalReportData = {
                    ...reportData,
                    emotionVector,
                    summary: getSummaryPlainText(reportData.summary),
                    mindScore: Math.max(0, Math.min(100, mindScore)),
                    bodyScore: Math.max(0, Math.min(100, bodyScore)),
                    combinedScore: Math.max(0, Math.min(100, combinedScore)),
                    extremeLanguage: {
                        detected: extremeCount > 0,
                        matchedKeywords: Array.from(matchedKeywords),
                        deductAmount: deductAmount
                    }
                };

                try {
                    const response = await fetch('{{ url_for("save_psychology_scores") }}', {
                        method: 'POST',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            mindScore: finalReportData.mindScore,
                            bodyScore: finalReportData.bodyScore,
                            combinedScore: finalReportData.combinedScore,
                            summary: finalReportData.summary,
                            keywords: finalReportData.keywords,
                            emotionVector: finalReportData.emotionVector,
                            conversationHistory: appState.conversationHistory,
                            extremeLanguage: finalReportData.extremeLanguage
                        })
                    });

                    if (!response.ok) {
                        const errorPayload = await response.json().catch(() => ({}));
                        throw new Error(errorPayload.error || `HTTP ${response.status}`);
                    }
                } catch (error) {
                    console.error("Failed to save scores:", error);
                    addMessage('gemini', "紀錄分數時遇到問題，請稍後再試一次。");
                }

                displayReport(finalReportData);
            } catch (error) {
                console.error("Report Generation Error:", error);
                addMessage('gemini', "糟糕，整理的時候不小心把墨水打翻了，請稍後再試一次。");
                appState.isReportGenerated = false;
            } finally {
                setLoading(false);
            }
        }
        function updateProgressBar(percentage) {
            progressBarFill.style.width = `${Math.min(100, percentage)}%`;
        }

        function buildPrompt() {
            let systemInstruction;
            
            if (appState.mode === 'deep-chat') {
                systemInstruction = `
                    你的角色: 你是個超棒的喵奶奶，你說話很溫柔、很有同理心喔！
                    你的任務:
                    1. 每次回覆前，都要先用一句話同理一下使用者，例如：「喔～聽起來你好像覺得...」
                    2. 然後再問一個開放式問題，讓使用者能多說一些心裡話。
                    3. 語氣要一直保持暖心又慈祥！
                    4. 不要自己決定何時結束對話，使用者會點擊按鈕來產生報告。
                    
                    回傳格式 (必須是嚴格的 JSON):
                    {
                      "nextPrompt": "你的回覆文字。",
                      "isAnalysisReady": false
                    }
                `;
            } else { 
                const isFirstInteraction = appState.turnCount <= 1;
                if(isFirstInteraction) {
                     systemInstruction = `
                        你的角色: 你是個專業又好奇的喵記者。
                        你的任務 (初次對話):
                        1. 根據使用者的主題選擇 ("工作", "健康", 或 "人際關係")，提出第一個相關問題。
                        2. 問題要簡潔明瞭，並附上三個相關的快速回覆按鈕選項。
                        3. 對話的「信心指數」（confidence_0_100）從 20 開始。
                        4. 訪談最多只能提出 15 題選擇題，第 15 題要在題目前加上「【這是最後一題】」，之後不要再出題或提供選項。
                        
                        回傳格式 (必須是嚴格的 JSON):
                        {
                          "nextPrompt": "你的回覆文字，請問得簡單明瞭。",
                          "quickReplies": ["選項1", "選項2", "選項3"],
                          "isAnalysisReady": false,
                          "confidence_0_100": 20
                        }
                    `;
                } else {
                     systemInstruction = `
                        你的角色: 你是個專業又好奇的喵記者。
                        你的任務 (對話中):
                        1. 根據使用者最新的回答，繼續問下一個簡潔又直接的問題。
                        2. 同時給他三個相關的快速回覆選項。
                        3. 「信心指數」(confidence_0_100) 在之前的 ${appState.confidence} 基礎上增加 15-25。
                        4. 不要自己決定何時結束對話，使用者會看到一個按鈕來決定何時產生報告。
                        5. 訪談最多只能提出 15 題選擇題，第 15 題要在題目前加上「【這是最後一題】」，之後不要再出題或提供選項。
                        
                        回傳格式 (必須是嚴格的 JSON):
                        {
                          "nextPrompt": "你的回覆文字。",
                          "quickReplies": ["選項1", "選項2", "選項3"],
                          "isAnalysisReady": false,
                          "confidence_0_100": ${Math.min(100, appState.confidence + 20)}
                        }
                    `;
                }
            }
            return systemInstruction;
        }

        function buildReportPrompt() {
            const conversationText = appState.conversationHistory
                .map(msg => {
                    let text = msg.parts[0].text;
                    try {
                        const parsed = JSON.parse(text);
                        if (typeof parsed === 'object' && parsed.nextPrompt) {
                            text = parsed.nextPrompt;
                        }
                    } catch (e) { /* It's a plain string, do nothing */ }
                    const role = msg.role === 'model' ? (appState.mode === 'deep-chat' ? '喵奶奶' : '喵記者') : '使用者';
                    return `${role}: ${text}`;
                })
                .join('\n\n');

            const healthSummaryBlock = formatHealthReportForPrompt();
            const personaPrompt = appState.mode === 'deep-chat' 
                ? '請你扮演「喵奶奶」的角色，用極度溫柔、慈祥且充滿鼓勵的口吻，像貓咪一樣慵懶溫暖地做出總結。在總結中，請適時使用 **粗體字** 來強調重點，並在結尾加上一個溫暖的表情符號，例如 ✨ 或 ❤️。語氣必須非常正面，巧妙地融入貓咪元素（例如：呼嚕、毛線球、曬太陽等）。'
                : '請你扮演「喵記者」的角色，用專業、敏銳且充滿活力的口吻，像貓咪一樣好奇地做出總結。在總結中，請適時使用 **粗體字** 來強調重點，並在結尾加上一個活潑的表情符號，例如 ✨ 或 🐾。語氣必須非常正面，巧妙地融入貓咪元素（例如：貓掌、頭條、獨家新聞等）。';

            return `
                你的角色: 你是一位專業的心理分析師，同時也是一位溫暖的貓咪夥伴。
                你的任務: 根據以下的健康報告摘要與對話紀錄，產生一份結構化的分析報告，並將身心狀態串連在一起給出建議。切記不可直接揭露血壓、血脂等具體檢驗數值，需以趨勢或感受性的描述代替。情緒分析需基於 VAD 模型（Valence-Arousal-Dominance），根據對話內容和健康數據動態生成 emotionVector 的值，範圍嚴格限制在 1-100：
                - Valence（情緒正負）：反映對話中的正面（高分）或負面（低分）情緒。
                - Arousal（喚醒度）：反映對話中的情緒強度，低分表示平靜，高分表示激動。
                - Dominance（支配感）：反映對話中用戶的控制感，低分表示無力感，高分表示掌控感。
                額外規則：掃描用戶對話中的極端或激進語言（如咒罵、威脅、極端負面詞如“恨死”“毀滅”“絕望”“暴力”等）。如果檢測到，斟酌扣分：降低 valence 10-20 分（更負面）、增加 arousal 10-20 分（更激動）、降低 dominance 10-20 分（更無力），視嚴重度調整（例如多次出現則扣更多），但確保值在 1-100 範圍內。

                健康報告摘要:
                ---
                ${healthSummaryBlock}
                ---

                對話紀錄:
                ---
                ${conversationText}
                ---

                總結的風格指南: ${personaPrompt}

                請嚴格遵循以下的 JSON 格式回傳，不要有任何額外的文字或解釋:
                {
                "summary": "一段約 100-150 字的溫暖總結，用第二人稱（你）的角度，同理並總結使用者的狀況。不可出現任何檢驗數值或具體數字，需用趨勢性的描述呈現健康面向。必須遵循上述的風格指南，使用 **粗體** 和表情符號 ✨。",
                "keywords": ["一個包含3-5個核心議題關鍵字的陣列"],
                "emotionVector": {
                    "valence": "1-100 的整數，基於對話情緒正負",
                    "arousal": "1-100 的整數，基於對話情緒強度",
                    "dominance": "1-100 的整數，基於對話控制感"
                }
                }
            `;
        }
        async function callChatAPI(systemInstruction) {
            const response = await fetch('{{ url_for("chat_api") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    conversationHistory: appState.conversationHistory,
                    systemInstruction: systemInstruction
                })
            });
            if (response.ok) {
                return await response.json();
            } else {
                console.error("API call failed:", response.status);
                return { nextPrompt: "網路好像不太穩定，請檢查連線後再試一次。" };
            }
        }
        
        async function callReportAPI() {
            const response = await fetch('{{ url_for("report_api") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    conversationHistory: appState.conversationHistory,
                    systemInstruction: buildReportPrompt()
                })
            });
            if (response.ok) {
                return await response.json();
            } else {
                console.error("Report API call failed:", response.status);
                return { summary: "抱歉，整理總結時出了點小差錯，請稍後再試。" };
            }
        }

        function addMessage(sender, text) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex items-end gap-2 max-w-[85%] chat-bubble ${sender === 'user' ? 'self-end flex-row-reverse' : 'self-start'}`;

            const bubble = document.createElement('div');
            bubble.className = `p-3 rounded-2xl`;
            bubble.classList.add('chat-message');

            let avatarElement = null;

            if (sender === 'user') {
                const userImg = document.createElement('img');
                userImg.src = userAvatarUrl;
                userImg.alt = '使用者頭像';
                userImg.className = 'user-avatar';
                bubble.classList.add('bg-[var(--user-bubble)]', 'text-[var(--text-primary)]', 'rounded-br-none');
                bubble.textContent = text;
                avatarElement = userImg;
            } else { 
                bubble.classList.add('bg-[var(--gemini-bubble)]', 'text-[var(--text-primary)]', 'rounded-bl-none', 'border', 'border-gray-100');
                bubble.textContent = text;

                if (appState.mode === 'deep-chat') {
                    const grandmaImg = document.createElement('img');
                    grandmaImg.src = grandmaAvatarUrl;
                    grandmaImg.alt = '喵奶奶春蘭';
                    grandmaImg.className = 'grandma-avatar';
                    avatarElement = grandmaImg;
                } else {
                    const reporterImg = document.createElement('img');
                    reporterImg.src = reportAvatarUrl;
                    reporterImg.alt = '喵記者馬克';
                    reporterImg.className = 'reporter-avatar';
                    avatarElement = reporterImg;
                }
            }

            if (avatarElement) {
                messageWrapper.appendChild(avatarElement);
            }

            messageWrapper.appendChild(bubble);
            chatHistory.appendChild(messageWrapper);
            chatHistory.scrollTop = chatHistory.scrollHeight;

            if (sender !== 'user' && avatarElement) {
                const shouldPulse = (appState.mode === 'deep-chat' && avatarElement.classList.contains('grandma-avatar')) ||
                    (appState.mode === 'quick-qa' && avatarElement.classList.contains('reporter-avatar'));
                if (shouldPulse) {
                    triggerAvatarPulse(avatarElement);
                }
            }
        }


function setLoading(isLoading, customMessage = null) {
            appState.isLoading = isLoading;
            sendButton.disabled = isLoading;
            messageInput.disabled = isLoading;
            const nextPlaceholder = isLoading ? "貓咪正在思考中..." : resolvedPlaceholderText;
            messageInput.placeholder = nextPlaceholder;

            const existingLoader = document.getElementById('loading-indicator');
            if (existingLoader) {
                existingLoader.remove();
            }

            if (isLoading) {
                const messageWrapper = document.createElement('div');
                messageWrapper.id = 'loading-indicator';
                messageWrapper.className = 'flex items-center gap-3 self-start chat-bubble';

                let loaderAvatar = null;
                if (appState.mode === 'deep-chat') {
                    const grandmaImg = document.createElement('img');
                    grandmaImg.src = grandmaAvatarUrl;
                    grandmaImg.alt = '喵奶奶春蘭';
                    grandmaImg.className = 'grandma-avatar';
                    loaderAvatar = grandmaImg;
                } else {
                    const reporterImg = document.createElement('img');
                    reporterImg.src = reportAvatarUrl;
                    reporterImg.alt = '喵記者馬克';
                    reporterImg.className = 'reporter-avatar';
                    loaderAvatar = reporterImg;
                }

                const bubble = document.createElement('div');
                bubble.className = 'p-3 rounded-2xl bg-[var(--gemini-bubble)] border border-gray-100 flex items-center gap-3';
                const dots = document.createElement('div');
                dots.className = 'dot-flashing';
                const loadingText = document.createElement('span');
                loadingText.className = 'text-sm text-[var(--text-secondary)] italic chat-message';
                const messages = loadingMessages[appState.mode] || ['請稍候...'];
                loadingText.textContent = customMessage || messages[Math.floor(Math.random() * messages.length)];

                bubble.appendChild(dots);
                bubble.appendChild(loadingText);
                if (loaderAvatar) {
                    messageWrapper.appendChild(loaderAvatar);
                }
                messageWrapper.appendChild(bubble);
                chatHistory.appendChild(messageWrapper);
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }
        }

        function triggerAvatarPulse(avatarElement) {
            if (!avatarElement) return;
            avatarElement.classList.add('is-speaking');
            setTimeout(() => {
                avatarElement.classList.remove('is-speaking');
            }, GRANDMA_PULSE_DURATION);
        }

        function renderQuickReplies(replies) {
            clearQuickReplies();
            replies.forEach(reply => {
                const button = document.createElement('button');
                button.className = "bg-gray-100 hover:bg-[var(--accent-primary-hover)] hover:text-white text-sm text-[var(--text-secondary)] font-medium py-1.5 px-3 rounded-full transition-all border border-gray-200";
                button.textContent = reply;
                button.onclick = () => sendMessage(reply);
                quickRepliesContainer.appendChild(button);
            });
        }

        function clearQuickReplies() {
            quickRepliesContainer.innerHTML = '';
        }

        function displayReport(reportData) {
            const formattedSummary = formatSummary(reportData.summary);
            reportSummary.innerHTML = `<p>${formattedSummary}</p>`;

            showResultModal();
            window.currentReportData = reportData;
        }

        function formatHealthReportForPrompt() {
            if (!healthReportData) {
                return '健康報告資料不足，僅能依對話資訊提供建議。';
            }

            const score = healthReportData.health_score;
            const warnings = Array.isArray(healthReportData.health_warnings)
                ? healthReportData.health_warnings.filter(Boolean)
                : [];
            const warningText = warnings.length ? warnings.join('、') : '目前沒有特別警示項目';

            const vitalStats = healthReportData.vital_stats || {};
            const vitalLines = Object.entries(vitalStats)
                .filter(([, value]) => value !== null && value !== '' && value !== undefined)
                .map(([key, value]) => `${key}: ${value}`)
                .slice(0, 12)
                .join('\n');

            return [
                `健康分數：${typeof score === 'number' ? score : '無提供'}`,
                `重點警示：${warningText}`,
                vitalLines ? `主要指標：\n${vitalLines}` : '主要指標：資料不足'
            ].join('\n');
        }

        function buildHealthInsightSnippet() {
            if (!healthReportData) return '';

            const warnings = Array.isArray(healthReportData.health_warnings)
                ? healthReportData.health_warnings.filter(Boolean)
                : [];

            const adviceCatalog = [
                { pattern: /(糖化血色素|hemoglobin_a1c)/i, advice: '調整甜食與精緻澱粉攝取，安排規律運動幫助血糖穩定' },
                { pattern: /(三酸甘油酯|triglycerides)/i, advice: '少吃油炸與高糖飲品，改以高纖蔬果與好油脂為主' },
                { pattern: /(總膽固醇|total_cholesterol|低密度|ldl)/i, advice: '試著增加日常活動量並挑選低脂蛋白質' },
                { pattern: /(體重|bmi)/i, advice: '維持規律運動與均衡飲食，幫身體找到舒適節奏' },
                { pattern: /(血壓|systolic|diastolic)/i, advice: '留意鹽分與作息，放慢生活步調讓血壓放鬆' },
                { pattern: /(尿蛋白|urine_protein|尿糖|urine_glucose)/i, advice: '多補水、適量運動並定期追蹤腎臟狀況' }
            ];

            const advices = [];
            warnings.forEach(warning => {
                for (const entry of adviceCatalog) {
                    if (entry.pattern.test(warning)) {
                        if (!advices.includes(entry.advice)) {
                            advices.push(entry.advice);
                        }
                        return;
                    }
                }
            });

            if (!advices.length && typeof healthReportData.health_score === 'number') {
                if (healthReportData.health_score >= 80) {
                    advices.push('持續保持好習慣，讓身體維持在喜歡的節奏');
                } else {
                    advices.push('規律動一動、調整飲食比例，讓身體慢慢回到舒服狀態');
                }
            }

            return advices.slice(0, 2).join('，');
        }

        function getSummaryPlainText(rawSummary) {
            const cleaned = (rawSummary || '').trim();
            const summaryText = (!cleaned || /模型沒有產生報告內容/.test(cleaned))
                ? buildFallbackSummary()
                : cleaned;
            return summaryText.replace(/\*\*(.*?)\*\*/g, '$1');
        }

        function formatSummary(rawSummary) {
            const plainText = getSummaryPlainText(rawSummary);
            return plainText.replace(/\*\*(.*?)\*\*/g, '<strong class="text-purple-600">$1</strong>');
        }

        function buildFallbackSummary() {
            const userMessages = appState.conversationHistory
                .filter(msg => msg.role === 'user')
                .map(msg => {
                    const part = Array.isArray(msg.parts) && msg.parts.length ? msg.parts[0] : null;
                    if (!part) return '';
                    if (typeof part === 'string') return part;
                    return part.text || '';
                })
                .filter(Boolean);

            const latestShare = userMessages.length ? userMessages[userMessages.length - 1] : '你剛剛分享的心情';
            const snippet = latestShare.length > 20 ? `${latestShare.slice(0, 20)}…` : latestShare;
            const healthHint = buildHealthInsightSnippet();
            const healthSentence = healthHint ? `也可以試著${healthHint}，讓身體慢慢找到舒服的節奏。` : '';
            return `我聽見你提到「${snippet}」，那份在意很真實。${healthSentence}記得放慢腳步、給自己一點緩衝，必要時也和信任的夥伴聊聊。我會在這裡陪你，一起等心情變得更輕鬆。✨`;
        }

    </script>
</body>
</html>
